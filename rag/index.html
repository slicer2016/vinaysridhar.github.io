<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAG System | Vinay Sridhar</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
    }
    .rag-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }
    .query-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    .query-button {
      background-color: #0070f3;
      color: white;
      font-weight: bold;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .query-button:hover {
      background-color: #0051b3;
    }
    .citation {
      font-size: 0.7rem;
      vertical-align: super;
      color: #0070f3;
      cursor: pointer;
    }
    .answer-box {
      background-color: #f7f9fc;
      border-left: 4px solid #0070f3;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0 4px 4px 0;
    }
    .source-box {
      background-color: #f5f5f5;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .loading-spinner {
      display: none;
      margin-left: 1rem;
      width: 1.5rem;
      height: 1.5rem;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0070f3;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-3xl font-bold mb-6">Website RAG System</h1>

    <div class="rag-card">
      <h2 class="text-xl font-semibold mb-4">Ask a question about Vinay</h2>
      <div class="flex flex-col">
        <input type="text" id="query-input" class="query-input" placeholder="e.g., Where does Vinay live?" />
        <div class="flex items-center">
          <button id="query-button" class="query-button">Ask</button>
          <div id="loading-spinner" class="loading-spinner"></div>
        </div>
      </div>

      <div id="answer-container" class="mt-6" style="display: none;">
        <h3 class="text-lg font-medium mb-2">Answer:</h3>
        <div id="answer-box" class="answer-box">
          <p id="answer-text"></p>
        </div>

        <div id="sources-container" class="mt-4" style="display: none;">
          <h3 class="text-lg font-medium mb-2">Sources:</h3>
          <div id="sources-list"></div>
        </div>
      </div>
    </div>

    <div class="rag-card">
      <h2 class="text-xl font-semibold mb-4">Example Questions</h2>
      <ul class="list-disc pl-5 space-y-2">
        <li><a href="#" class="text-blue-600 hover:underline example-query">Where does Vinay live?</a></li>
        <li><a href="#" class="text-blue-600 hover:underline example-query">What are Vinay's principles?</a></li>
        <li><a href="#" class="text-blue-600 hover:underline example-query">What books did Vinay read in 2023?</a></li>
        <li><a href="#" class="text-blue-600 hover:underline example-query">What technologies does Vinay work with?</a></li>
      </ul>
    </div>

    <div class="rag-card">
      <h2 class="text-xl font-semibold mb-4">About This RAG System</h2>
      <p class="mb-4">
        This is a Retrieval-Augmented Generation (RAG) system built for vinaysridhar.com. It uses LangChain, OpenAI embeddings,
        and a custom retrieval pipeline to provide accurate answers about content from the website.
      </p>
      <p>
        The system includes optimized chunking, precomputed embeddings, anti-hallucination techniques, and citation support
        to ensure high-quality, factual responses.
      </p>
    </div>

    <p class="text-sm text-gray-600 mt-8 text-center">
      Built with Next.js, LangChain, and OpenAI. View the <a href="https://github.com/slicer2016/website-rag" class="text-blue-600 hover:underline">source code</a>.
    </p>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const queryInput = document.getElementById('query-input');
      const queryButton = document.getElementById('query-button');
      const answerContainer = document.getElementById('answer-container');
      const answerText = document.getElementById('answer-text');
      const sourcesContainer = document.getElementById('sources-container');
      const sourcesList = document.getElementById('sources-list');
      const loadingSpinner = document.getElementById('loading-spinner');

      // Example query links
      document.querySelectorAll('.example-query').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          queryInput.value = this.textContent;
          queryButton.click();
        });
      });

      // Handle query submission
      queryButton.addEventListener('click', async function() {
        const query = queryInput.value.trim();
        if (!query) return;

        // Show loading state
        loadingSpinner.style.display = 'block';
        answerContainer.style.display = 'none';
        sourcesContainer.style.display = 'none';

        try {
          // Fetch answer from API
          const response = await fetch('https://rag.vinaysridhar.com/api/rag', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query })
          });

          if (!response.ok) throw new Error('Failed to get response');

          const data = await response.json();

          // Parse citations from answer
          const answer = data.response;
          const sources = data.citations || [];

          // Display answer with clickable citations
          let formattedAnswer = answer;
          if (sources.length > 0) {
            sources.forEach((source, i) => {
              const citationMark = `[${i+1}]`;
              formattedAnswer = formattedAnswer.replace(
                new RegExp(`\\[${i+1}\\]`, 'g'),
                `<sup class="citation" data-index="${i}">${citationMark}</sup>`
              );
            });
          }

          answerText.innerHTML = formattedAnswer;

          // Display sources
          if (sources.length > 0) {
            sourcesList.innerHTML = '';
            sources.forEach((source, i) => {
              const sourceEl = document.createElement('div');
              sourceEl.className = 'source-box';
              sourceEl.innerHTML = `
                <p><strong>[${i+1}]</strong> ${source.title || 'Untitled'}</p>
                <p><em>${source.source || ''}</em></p>
                <p>${source.text || ''}</p>
              `;
              sourcesList.appendChild(sourceEl);
            });
            sourcesContainer.style.display = 'block';
          }

          // Add click handlers for citations
          document.querySelectorAll('.citation').forEach(citation => {
            citation.addEventListener('click', function() {
              const index = this.dataset.index;
              const sourceEl = sourcesList.children[index];
              sourceEl.scrollIntoView({ behavior: 'smooth' });
              sourceEl.style.backgroundColor = '#ffffcc';
              setTimeout(() => {
                sourceEl.style.backgroundColor = '#f5f5f5';
              }, 2000);
            });
          });

          // Show answer
          answerContainer.style.display = 'block';

        } catch (error) {
          console.error('Error:', error);
          answerText.textContent = 'Sorry, I encountered an error while processing your question. Please try again.';
          answerContainer.style.display = 'block';
        } finally {
          loadingSpinner.style.display = 'none';
        }
      });

      // Handle Enter key in input
      queryInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          queryButton.click();
        }
      });
    });
  </script>
</body>
</html>